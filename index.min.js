function shuffle(arr,size){size||(size=arr.length);for(var tmp=arr.slice(),ret=[];tmp.length&&ret.length<size;){var index=Math.random()*tmp.length|0;ret.push(tmp[index]),tmp.splice(index,1)}return ret}function to(name,done){var target=$('[data-name="'+name+'"]').last(),height=100*+target.attr("data-index");target.siblings().removeClass("on").end().addClass("on"),new Promise(function(resolve){$(".container").css("top",0).animate({top:-height},1500,"easeOutElastic",function(){resolve($(".xcon").position())})}).then(function(pos){var $li=$("<li/>").addClass("groupli").text(name).appendTo($(document.body));$li.css({position:"fixed",left:pos.left,top:pos.top});var $holder=$("<li/>").addClass("groupli");$holder.appendTo($(".group")),$li.animate({left:$holder.position().left,top:$holder.position().top},"slow",function(){$li.css("position","static"),$holder.replaceWith($li),done()})})}function toPrize(name){var target=$('[data-name="'+name+'"]').last(),height=100*+target.attr("data-index");target.siblings().removeClass("on").end().addClass("on"),new Promise(function(resolve){$(".container").css("top",0).animate({top:-height},1500,"easeOutElastic",function(){resolve()})}).then(function(){$(".dialog").find("h1").text(name).end().show()})}function select(){if(!groupNames){var pmSize=pm.length;groupNames=[];for(var bpPm=pm.slice(),bpPo=shuffle(poss,20-pmSize),i=0;i<Math.max(bpPm.length,bpPo.length);++i){var tmp=[];bpPm[i]&&tmp.push(bpPm[i]),bpPo[i]&&tmp.push(bpPo[i]),groupNames=groupNames.concat(shuffle(tmp))}var m=[];for(i=0;i<groupNames.length;i+=2)m.push([groupNames[i],groupNames[i+1]]);m=shuffle(m),groupNames=m.reduce(function(p,n){return p.concat(n)})}total--;var name=groupNames.shift();preName=name,to(name,function(){total&&select()})}for(var spm=["胡蓉","第一帅"],pm=["佳薇","刘媛","刘赫","张鹤","吴朦"],po=["阿哥","铁牛"],poss=["铁马","五爷","六婊","倪倪","小曼","夹夹","玛丽","小兰","闻静","小贝","菜菜","晓丹","峰姐","海洋","铁柱","小海","底迪","赵祎","庆庆","小花","李鹏","陈梦","雨探","小饱","阿毛","蛋蛋","小熊","静宁","杨老师","大师兄"],names=shuffle(spm.concat(pm).concat(po).concat(poss)),index=0,sb=function(name){return $("<div/>").text(name).addClass("item").attr("data-name",name).attr("data-index",index++)},$names=[],i=0;2>i;++i)$names=$names.concat(names.map(sb));$(".container").append($names);var total=0,groupNames,preName,prizeNames,pickedName;$(document).on("click",".do-group",function(e){e.preventDefault(),total?console.log("forbidden"):(total=20,groupNames=null,preName=null,$(".group").empty(),select())}).on("click",".do-prize",function(e){e.preventDefault(),total?console.log("forbidden"):(prizeNames||(prizeNames=shuffle(names)),pickedName=shuffle(prizeNames,1)[0]||"奖品发完啦",toPrize(pickedName,function(){}))}).on("click",".dialog .buttons .get",function(){prizeNames=prizeNames.filter(function(item){return item!==pickedName}),$(".dialog").hide()}).on("click",".dialog .buttons .giveup",function(){$(".dialog").hide()});